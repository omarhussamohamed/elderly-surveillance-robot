#!/usr/bin/env python2
import smbus
import rospy

def test_i2c():
    print("=== I2C Diagnostic Test ===")
    
    # Try both I2C buses
    for bus_num in [0, 1, 7]:
        try:
            print(f"\nTrying I2C bus {bus_num}...")
            bus = smbus.SMBus(bus_num)
            
            # Try both possible addresses
            for address in [0x68, 0x69]:
                try:
                    # Read WHO_AM_I register (0x75)
                    whoami = bus.read_byte_data(address, 0x75)
                    print(f"  Address 0x{address:02x}: WHO_AM_I = 0x{whoami:02x}", end=" ")
                    
                    if whoami == 0x71:
                        print("← MPU9250 detected!")
                    elif whoami == 0x73:
                        print("← MPU9255 detected!")
                    else:
                          print(f"← Unknown device")
                    
                except IOError:
                    print(f"  Address 0x{address:02x}: No response")
                except Exception as e:
                    print(f"  Address 0x{address:02x}: Error - {e}")
            
            bus.close()
            
        except Exception as e:
            print(f"Could not open I2C bus {bus_num}: {e}")
    
    print("\n=== Checking I2C permissions ===")
    import os
    for dev in ["/dev/i2c-0", "/dev/i2c-1", "/dev/i2c-7"]:
        if os.path.exists(dev):
            perms = oct(os.stat(dev).st_mode)[-3:]
            print(f"{dev}: permissions {perms}")
            if perms != "666" and perms != "777":
                print(f"  WARNING: May need: sudo chmod 666 {dev}")
        else:
            print(f"{dev}: Does not exist")

if __name__ == "__main__":
    try:
        test_i2c()
    except KeyboardInterrupt:
        print("\nTest interrupted")