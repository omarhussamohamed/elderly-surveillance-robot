# robot_localization EKF Configuration
# Fuses wheel odometry from ESP32 with IMU data
# Publishes odom -> base_footprint transform

# Frequency of the filter (Hz)
frequency: 50

# Sensor timeout (seconds)
sensor_timeout: 0.1

# If true, will publish the transform from the world_frame to the base_link_frame
two_d_mode: true

# The filter accepts an arbitrary number of inputs from each input message type
# (Odometry, PoseStamped, TwistStamped, Imu). To add a new one, simply append
# the next number in the sequence to its base name, e.g., odom0, odom1, twist0, twist1

# ========== FRAME CONFIGURATION ==========

# Map frame (not used in odometry mode, only with navsat_transform_node)
map_frame: map

# Odometry frame
odom_frame: odom

# Base link frame
base_link_frame: base_footprint

# World frame (same as odom for local navigation)
# CRITICAL FIX: Keep as 'odom' but ensure wheel_odom publishes to DIFFERENT frame
# ESP32 should publish with frame_id='wheel_odom_frame', not 'odom'
world_frame: odom

# ========== WHEEL ODOMETRY (from ESP32) ==========

# Wheel odometry input
odom0: /odom

# Which values to fuse from wheel odometry
# [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
# CRITICAL FIX: Do NOT fuse vyaw from wheel odometry - it accumulates drift from wheel slip
# Only fuse position and linear velocity. IMU provides accurate yaw orientation.
odom0_config: [false,  false,  false,  # position (x, y, z)
               false, false, false,   # roll, pitch, yaw
               true,  false, false,   # vx, vy, vz
               false, false, false,   # vroll, vpitch, vyaw
               false, false, false]   # ax, ay, az

# Differential mode for odometry
odom0_differential: false

# Reject outliers
odom0_rejection_threshold: 2.0

# Queue size
odom0_queue_size: 10

# ========== IMU (MPU-9250) ==========

# IMU input (filtered by Madgwick)
imu0: /imu/data

# IMU configuration
# Fuse absolute orientation (roll, pitch, yaw) from Madgwick filter
# Fuse angular velocities and linear accelerations
imu0_config: [false, false, false,  # position (x, y, z)
              true,  true,  true,   # roll, pitch, yaw
              false, false, false,  # vx, vy, vz
              true,  true,  true,   # vroll, vpitch, vyaw
              true,  true,  true]   # ax, ay, az

# IMU differential mode
imu0_differential: true  # Integrate differences for orientation

# IMU rejection threshold
imu0_rejection_threshold: 0.5

# IMU queue size
imu0_queue_size: 10

# Remove gravitational acceleration from IMU
imu0_remove_gravitational_acceleration: true

# ========== PROCESS NOISE COVARIANCE ==========

# Process noise covariance matrix
# Increased noise for yaw and angular velocity due to skid-steer slip
process_noise_covariance: [0.05, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.05, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.06, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.03, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.03, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.06, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.025,0.0,  0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.025,0.0,  0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.04, 0.0,  0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.01, 0.0,  0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.01, 0.0,
                           0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.02]

# ========== INITIAL STATE COVARIANCE ==========

# Initial estimate covariance matrix
initial_estimate_covariance: [1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,  0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-9, 0.0,  0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3, 0.0,
                              0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e-3]

# ========== ADVANCED SETTINGS ==========

# Use control input (cmd_vel) to improve prediction
use_control: false

# Smoothing (Rauch-Tung-Striebel smoother)
smooth_lagged_data: false

# History length for smoothing
history_length: 0

# Print diagnostics
print_diagnostics: false

# Debug output
debug: false

# Debug output file
debug_out_file: /tmp/ekf_debug.txt