# rosserial Communication Troubleshooting Guide

## Error: "Unable to sync with device"

This error means rosserial_python cannot establish communication with the ESP32.

### Quick Fix Checklist

1. **Regenerate ros_lib** (MOST IMPORTANT)
   ```bash
   # On Jetson Nano
   cd ~/Arduino/libraries
   rm -rf ros_lib
   rosrun rosserial_arduino make_libraries.py .
   ```

2. **Verify ros_lib was created**
   ```bash
   ls ~/Arduino/libraries/ros_lib/
   # Should show: ros.h, ros/ directory, and message type folders
   ```

3. **Re-upload firmware to ESP32**
   - Open Arduino IDE
   - Open elderly_bot_esp32.ino
   - Upload to ESP32
   - **CRITICAL**: Must re-upload after regenerating ros_lib

4. **Test connection**
   ```bash
   rosrun rosserial_python serial_node.py _port:=/dev/ttyUSB0 _baud:=115200
   ```

## Detailed Troubleshooting

### Step 1: Verify Serial Connection

Test that serial communication works:

```bash
# Install screen if needed
sudo apt-get install screen

# Monitor serial output
screen /dev/ttyUSB0 115200
```

**Expected output**: You should see boot messages and potentially debug output.

**If no output**: 
- Check USB cable
- Verify port: `ls -l /dev/ttyUSB*`
- Check baud rate (must be 115200)

Press `Ctrl+A` then `K` to exit screen.

### Step 2: Check ros_lib Version

The ros_lib must match your ROS distribution (Melodic).

```bash
# Check if ros_lib exists
ls ~/Arduino/libraries/ros_lib/

# Check ros.h version
grep "ROS_VERSION" ~/Arduino/libraries/ros_lib/ros.h
```

**If ros_lib is missing or old**:
```bash
cd ~/Arduino/libraries
rm -rf ros_lib
rosrun rosserial_arduino make_libraries.py .
```

### Step 3: Verify Arduino Libraries

Required libraries in `~/Arduino/libraries/`:
- `ros_lib/` (generated by rosserial)
- `Rosserial_Arduino_Library/` (from Arduino Library Manager)
- `MPU9250/` (from Arduino Library Manager)

**Install missing libraries**:
1. Open Arduino IDE
2. Sketch → Include Library → Manage Libraries
3. Search and install:
   - "Rosserial Arduino Library"
   - "MPU9250" by hideakitai

### Step 4: Check Firmware Compilation

Compile firmware and check for errors:

```bash
# Using arduino-cli
arduino-cli compile --fqbn esp32:esp32:esp32 elderly_bot_esp32.ino

# Should complete without errors
```

**Common compilation errors**:
- `ros.h: No such file or directory` → ros_lib not generated
- `MPU9250.h: No such file or directory` → Install MPU9250 library
- LEDC errors → Wrong ESP32 core version (use 2.0.17)

### Step 5: Upload with Verbose Output

Upload firmware with verbose logging:

```bash
arduino-cli upload -p /dev/ttyUSB0 --fqbn esp32:esp32:esp32 --verbose elderly_bot_esp32.ino
```

Watch for upload errors or failures.

### Step 6: Monitor Serial Output

After upload, immediately monitor serial:

```bash
arduino-cli monitor -p /dev/ttyUSB0 -c baudrate=115200
```

**Expected output**:
```
...boot messages...
Elderly Bot ESP32 Firmware Starting...
Calibrating IMU - keep robot still...
IMU calibration complete!
Elderly Bot Ready!
```

**If you see**:
- Continuous reboots → LWIP crash, check Core version
- Garbled text → Wrong baud rate
- Nothing → Serial not initialized

### Step 7: Test rosserial Connection

```bash
# Terminal 1: Start roscore
roscore

# Terminal 2: Connect rosserial with verbose output
rosrun rosserial_python serial_node.py _port:=/dev/ttyUSB0 _baud:=115200
```

**Expected output**:
```
[INFO] ROS Serial Python Node
[INFO] Connecting to /dev/ttyUSB0 at 115200 baud
[INFO] Requesting topics...
[INFO] Note: subscribe buffer size is 512 bytes
[INFO] Setup subscriber on cmd_vel [geometry_msgs/Twist]
[INFO] Setup publisher on wheel_odom [nav_msgs/Odometry]
[INFO] Setup publisher on imu/data [sensor_msgs/Imu]
```

### Step 8: Verify Topics

If rosserial connects successfully:

```bash
# List topics
rostopic list
# Should show: /cmd_vel, /wheel_odom, /imu/data

# Check message rates
rostopic hz /wheel_odom
rostopic hz /imu/data

# Echo messages
rostopic echo /wheel_odom
rostopic echo /imu/data
```

## Common Issues and Solutions

### Issue 1: "Unable to sync with device"

**Cause**: ros_lib version mismatch

**Solution**:
```bash
cd ~/Arduino/libraries
rm -rf ros_lib
rosrun rosserial_arduino make_libraries.py .
# Re-upload firmware
```

### Issue 2: "Checksum does not match"

**Cause**: Serial communication errors, wrong baud rate, or buffer overflow

**Solution**:
- Verify baud rate is 115200 on both sides
- Check USB cable quality
- Increase buffer size (already done in updated firmware)
- Reduce message publishing rate

### Issue 3: Connection drops after a few seconds

**Cause**: Buffer overflow or message too large

**Solution**: Updated firmware now has 512-byte buffers, should handle this.

### Issue 4: ESP32 keeps rebooting

**Cause**: LWIP crash (Core 3.x issue)

**Solution**: Use ESP32 Arduino Core 2.0.17 (see ESP32_CORE_COMPATIBILITY.md)

### Issue 5: Topics not appearing

**Cause**: Topics not advertised or subscription failed

**Solution**:
- Check serial monitor for "Setup publisher/subscriber" messages
- Verify nh.advertise() and nh.subscribe() are called
- Check for memory issues (ESP32 running out of RAM)

## Advanced Debugging

### Enable rosserial Debug Output

Modify firmware to add debug output:

```cpp
// In setup(), after nh.initNode()
nh.loginfo("Node initialized");
nh.loginfo("Advertising topics...");
```

### Check ESP32 Memory

Add to setup():
```cpp
Serial.print("Free heap: ");
Serial.println(ESP.getFreeHeap());
```

Should show > 100KB free.

### Test Minimal Firmware

Create a minimal test to isolate the issue:

```cpp
#include <ros.h>
#include <std_msgs/String.h>

ros::NodeHandle nh;
std_msgs::String str_msg;
ros::Publisher test_pub("test", &str_msg);

void setup() {
  Serial.begin(115200);
  delay(1000);
  nh.initNode();
  nh.advertise(test_pub);
}

void loop() {
  str_msg.data = "hello";
  test_pub.publish(&str_msg);
  nh.spinOnce();
  delay(1000);
}
```

If this works, the issue is with the full firmware (likely buffer size or message complexity).

## Verification Steps

After fixing, verify:

1. ✅ Firmware compiles without errors
2. ✅ Firmware uploads successfully
3. ✅ Serial output shows boot messages
4. ✅ rosserial connects without "Unable to sync" error
5. ✅ Topics appear in `rostopic list`
6. ✅ `/wheel_odom` publishes at ~100 Hz
7. ✅ `/imu/data` publishes at ~100 Hz
8. ✅ `/cmd_vel` can be published and received by ESP32
9. ✅ Motors respond to velocity commands
10. ✅ No disconnections or crashes

## Key Points

1. **ALWAYS regenerate ros_lib on the target system (Jetson)**
2. **ALWAYS re-upload firmware after regenerating ros_lib**
3. **Use ESP32 Arduino Core 2.0.17** (not 3.x)
4. **Baud rate must be 115200** on both sides
5. **Buffer sizes matter** for large messages like Odometry

## Still Having Issues?

If problems persist after following this guide:

1. Check ESP32 Arduino Core version (must be 2.0.17)
2. Verify ROS Melodic installation
3. Test with a simple rosserial example first
4. Check for hardware issues (USB cable, power supply)
5. Review ESP32 serial monitor for error messages

## Reference

- rosserial_arduino: http://wiki.ros.org/rosserial_arduino
- rosserial troubleshooting: http://wiki.ros.org/rosserial_python/Troubleshooting
- ESP32 Arduino Core 2.0.17: https://github.com/espressif/arduino-esp32/releases/tag/2.0.17

