<?xml version="1.0"?>
<!--
  Elderly Bot Mapping Launch File - FIXED TIMING ISSUES
-->
<launch>
  <!-- ========== BRINGUP HARDWARE ========== -->
  <include file="$(find elderly_bot)/launch/bringup.launch">
    <!-- Disable camera for mapping to save CPU -->
    <arg name="enable_camera" value="false" />
  </include>
  
  <!-- Wait for TF to stabilize -->
  <param name="tf_timeout" value="2.0" />
  
  <!-- ========== GMAPPING (SLAM) ========== -->
  <node pkg="gmapping" 
        type="slam_gmapping" 
        name="slam_gmapping"
        output="screen"
        respawn="true"
        respawn_delay="10"
        launch-prefix="bash -c 'sleep 5.0; $0 $@'">  <!-- CRITICAL: Wait 5s before starting -->
    
    <!-- Load configuration -->
    <rosparam command="load" file="$(find elderly_bot)/config/gmapping.yaml" />
    
    <!-- CRITICAL: Explicitly set frames to avoid TF lookup issues -->
    <param name="odom_frame" value="odom" />
    <param name="base_frame" value="base_footprint" />
    <param name="map_frame" value="map" />
    
    <!-- CRITICAL: Disable unused services that cause the broken promise error -->
    <param name="map_update_interval" value="1.0" />
    <param name="transform_publish_period" value="0.05" />
    
    <!-- Scan topic remapping -->
    <remap from="scan" to="/scan" />
  </node>
  
  <!-- ========== EXPLORE LITE ========== -->
  <node pkg="explore_lite" 
        type="explore" 
        name="explore"
        output="screen"
        launch-prefix="bash -c 'sleep 7.0; $0 $@'">  <!-- Start after gmapping -->
    
    <param name="robot_base_frame" value="base_footprint" />
    <param name="costmap_topic" value="map" />
    <param name="visualize" value="true" />
    <param name="planner_frequency" value="0.5" />
    <param name="progress_timeout" value="30.0" />
    <param name="potential_scale" value="3.0" />
  </node>
  
  <!-- ========== FOXGLOVE BRIDGE FOR MAPPING ========== -->
  <node name="foxglove_bridge" 
        pkg="foxglove_bridge" 
        type="foxglove_bridge" 
        output="screen"
        launch-prefix="bash -c 'sleep 3.0; $0 $@'">
    <param name="port" value="8765" />
  </node>
  
</launch>