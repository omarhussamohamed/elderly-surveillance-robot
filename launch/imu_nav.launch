<?xml version="1.0"?>
<!--
  IMU Navigation Pipeline Launch File
  
  This launch file implements the standard ROS IMU processing pipeline:
  1. mpu9250_node.py → Publishes raw IMU data to /imu/data_raw
  2. imu_filter_madgwick → Fuses raw IMU + magnetometer → Publishes to /imu/data
  
  Data Flow:
  /imu/data_raw (raw accel + gyro) ─> imu_filter_madgwick ─> /imu/data (fused orientation)
  
  Magnetometer DISABLED: use_mag=false (indoor EMI protection)
  
  Hardware Setup:
  - MPU9250 connected to Jetson I2C bus (default: bus 1, address 0x68)
  - SDA → Jetson I2C SDA (Pin 3 on J21)
  - SCL → Jetson I2C SCL (Pin 5 on J21)
  - VCC → 3.3V, GND → GND
-->

<!-- Add at the top of imu_nav.launch -->
<arg name="enable_i2c_debug" default="true" 
     doc="Enable I2C debug messages" />

 ##<arg name="enable_i2c_debug" default="true" 
##doc="Enable I2C debug messages" />
<launch>
  <!-- ========================================= -->
  <!-- MPU9250 Raw Data Node Parameters -->
  <!-- ========================================= -->
   <param name="frame_id" value="$(arg frame_id)" />
  <param name="publish_rate" value="$(arg publish_rate)" />
  <param name="i2c_bus" value="$(arg i2c_bus)" />
  <param name="i2c_address" value="$(arg i2c_address)" />
  <!-- ========================================= -->
  <!-- Madgwick Filter Parameters -->
  <!-- ========================================= -->
  <arg name="madgwick_gain" default="0.1" />  <!-- Fusion gain (0.0-1.0, higher = trust gyro more) -->
  <arg name="madgwick_zeta" default="0.05" />  <!-- Gyro bias drift correction (INCREASED for better stationary stability) -->
  <arg name="madgwick_mag_bias_x" default="-0.00004252" />  <!-- Magnetometer bias calibration -->
  <arg name="madgwick_mag_bias_y" default="0.00004791" />
  <arg name="madgwick_mag_bias_z" default="0.00002824" />
  
  <!-- ========================================= -->
  <!-- 1. MPU9250 Raw Data Publisher -->
  <!-- ========================================= -->
  <node name="mpu9250_node" 
        pkg="elderly_bot" 
        type="mpu9250_node.py"
        output="screen"
        respawn="false">
    <param name="frame_id" value="$(arg frame_id)" />
    <param name="publish_rate" value="$(arg publish_rate)" />
    <param name="i2c_bus" value="$(arg i2c_bus)" />
    <param name="i2c_address" value="$(arg i2c_address)" />
    
    <!-- Topics published:
         - /imu/data_raw (sensor_msgs/Imu) - Raw accelerometer + gyroscope
         Note: Magnetometer DISABLED (use_mag=false, indoor EMI protection)
    --><param name="debug_i2c" value="$(arg enable_i2c_debug)" />
</node>
  </node>
  
  <!-- ========================================= -->
  <!-- 2. IMU Orientation Filter (Madgwick) -->
  <!-- ========================================= -->
  <node name="imu_filter" 
        pkg="imu_filter_madgwick" 
        type="imu_filter_node"
        output="screen"
        respawn="true"
        respawn_delay="2">
    
    <!-- Input Topics -->
    <remap from="/imu/data_raw" to="/imu/data_raw" />
    <!-- Note: /imu/mag removed - magnetometer DISABLED (indoor EMI) -->
    
    <!-- Output Topic -->
    <remap from="/imu/data" to="/imu/data" />
    
    <!-- Sensor Configuration -->
    <!-- EMERGENCY FIX: MAGNETOMETER DISABLED - causing 60° yaw jumps indoors! -->
    <!-- Indoor environment: metal chassis, motors, Jetson PSU corrupt mag readings -->
    <!-- Magnetometer reads 500-2000 μT local fields vs 50 μT Earth field -->
    <!-- Result: Random yaw orientation, robot rotates while stationary -->
    <param name="use_mag" value="false" />  <!-- DISABLED: Gyro-only mode for indoor use -->
    <param name="use_magnetic_field_msg" value="false" />  <!-- Not using mag data -->
    <param name="publish_tf" value="false" />  <!-- Disable TF - using static transform instead -->
    <param name="reverse_tf" value="false" />  <!-- TF direction: imu_link is child of base_link -->
    
    <!-- Frame IDs -->
    <param name="fixed_frame" value="odom" />  <!-- Fixed reference frame -->
    <param name="world_frame" value="enu" />  <!-- World frame convention (East-North-Up) - data already remapped in node -->
    
    <!-- Filter Parameters -->
    <!-- EMERGENCY FIX: Higher gain since mag disabled (gyro-only mode) -->
    <!-- gain=0.9 means trust gyro 90%, accel 10% for tilt correction -->
    <!-- No mag → no yaw jumps, only slow gyro drift (acceptable indoors) -->
    <param name="gain" value="0.9" />  <!-- HIGH: Gyro-dominant (was 0.1 for mag fusion) -->
    <param name="zeta" value="$(arg madgwick_zeta)" />  <!-- Gyro drift compensation -->
    
    <!-- Magnetometer Calibration (adjust after mag calibration) -->
    <param name="mag_bias/x" value="$(arg madgwick_mag_bias_x)" />
    <param name="mag_bias/y" value="$(arg madgwick_mag_bias_y)" />
    <param name="mag_bias/z" value="$(arg madgwick_mag_bias_z)" />
    
    <!-- Orientation Initialization -->
    <param name="stateless" value="false" />  <!-- Use previous state for continuity -->
    <param name="remove_gravity_vector" value="true" />  <!-- Remove gravity from linear acceleration -->
    
    <!-- Output Configuration -->
    <param name="publish_debug_topics" value="false" />  <!-- Set true for debugging -->
  </node>
  
  <!-- ========================================= -->
  <!-- 3. Static Transform: base_link → imu_link -->
  <!-- ========================================= -->
  <!-- 
    REMOVED: This transform is now published by robot_state_publisher
    from the URDF file (elderly_bot.urdf).
    
    If you need to adjust IMU mounting, edit the URDF joint:
    base_link_to_imu_link in urdf/elderly_bot.urdf
  -->
  
  <!-- ========================================= -->
  <!-- Notes & Troubleshooting -->
  <!-- ========================================= -->
  <!--
    Topic Outputs:
    - /imu/data_raw   → Raw IMU (gyro + accel, no orientation)
    - /imu/data       → Fused IMU (with orientation from Madgwick filter)
    
    Verification Commands:
    rostopic list | grep imu
    rostopic hz /imu/data_raw /imu/data
    rostopic echo /imu/data
    
    IMU Calibration:
    - Gyro auto-calibrates on startup (keep robot stationary for 2 seconds)
    - Madgwick filter uses gyro+accel only (magnetometer DISABLED)
    
    Filter Tuning:
    - Current: gain=0.9 (gyro-dominant, no magnetometer)
    - Increase 'gain' → More responsive, trust gyro more
    - Decrease 'gain' → More smooth, trust accel tilt correction more
    
    Common Issues:
    - If orientation drifts slowly: Normal for gyro-only mode indoors (EKF corrects it)
    - If orientation jitters: Reduce gain, check sensor mounting (vibrations)
    - If no /imu/data output: Check /imu/data_raw is publishing, verify imu_filter_madgwick package installed
  -->
</launch>
