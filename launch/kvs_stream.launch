<!-- 
  ElderlyBot KVS Stream Launch File - HIGH RESOLUTION
  Optimized for 1280x720 @ 30fps streaming
  Enhanced for stability on Jetson Nano
  
  Usage:
    # High resolution streaming (1280x720 @ 30fps)
    roslaunch elderly_bot kvs_stream.launch
    
    # Lower resolution for testing
    roslaunch elderly_bot kvs_stream.launch width:=640 height:=480 fps:=15 bitrate:=512
-->

<launch>
  <!-- ========================================== -->
  <!-- ARGUMENTS -->
  <!-- ========================================== -->
  <arg name="device" default="/dev/video0" 
       doc="USB camera device path" />
  
  <!-- HIGH RESOLUTION SETTINGS - 1280x720 @ 30fps -->
  <arg name="width" default="1280" 
       doc="Camera width (1280 for high resolution)" />
  <arg name="height" default="720" 
       doc="Camera height (720 for high resolution)" />
  <arg name="fps" default="30" 
       doc="Frame rate (30fps for smooth video)" />
  
  <!-- KVS Streaming -->
  <arg name="enable_kvs" default="true" 
       doc="Enable AWS KVS streaming" />
  <arg name="bitrate" default="3000" 
       doc="H.264 bitrate in kbps (3000 for 1280x720)" />
  
  <!-- AWS KVS stream configuration -->
  <arg name="stream_name" default="RobotStream" 
       doc="AWS KVS stream name" />
  <arg name="aws_region" default="us-east-1" 
       doc="AWS region" />
  
  <!-- KVS Stability Parameters - Enhanced -->
  <arg name="retry_count" default="5" 
       doc="Number of stream reconnection attempts" />
  <arg name="retry_delay" default="3" 
       doc="Seconds between retries" />
  <arg name="buffer_duration" default="180" 
       doc="Buffer time in seconds for network drops" />
  <arg name="connection_timeout" default="45" 
       doc="Connection timeout in seconds" />
  <arg name="storage_size" default="512" 
       doc="Buffer storage in MB" />
  
  <!-- AWS Console playback optimization -->
  <arg name="fragment_duration" default="5" 
       doc="Fragment duration in seconds (5s for AWS console)" />
  
  <!-- Output Management -->
  <arg name="output_to_screen" default="true" 
       doc="Output KVS logs to screen" />

  <!-- ========================================== -->
  <!-- CAMERA NODE -->
  <!-- ========================================== -->
  <node pkg="elderly_bot" type="camera_node.py" name="camera_publisher" 
        output="screen" respawn="true" respawn_delay="5">
    <param name="device" value="$(arg device)" />
    <param name="width" value="$(arg width)" />
    <param name="height" value="$(arg height)" />
    <param name="fps" value="$(arg fps)" />
    <param name="frame_id" value="camera_link" />
  </node>

  <!-- ========================================== -->
  <!-- AWS KVS STREAMER NODE -->
  <!-- ========================================== -->
  <node pkg="elderly_bot" type="kvs_streamer_node.py" name="kvs_streamer" 
        output="screen" respawn="true" respawn_delay="10" if="$(arg enable_kvs)">
    
    <!-- AWS Environment Variables -->
    <env name="AWS_DEFAULT_REGION" value="$(arg aws_region)" />
    <!-- Suppress GStreamer logs -->
    <env name="GST_DEBUG" value="1" />
    <env name="GST_DEBUG_NO_COLOR" value="1" />
    
    <!-- Video parameters -->
    <param name="width" value="$(arg width)" />
    <param name="height" value="$(arg height)" />
    <param name="fps" value="$(arg fps)" />
    <param name="bitrate" value="$(arg bitrate)" />
    
    <!-- Stability parameters -->
    <param name="~retry_count" value="$(arg retry_count)" />
    <param name="~retry_delay" value="$(arg retry_delay)" />
    <param name="~buffer_duration" value="$(arg buffer_duration)" />
    <param name="~connection_timeout" value="$(arg connection_timeout)" />
    <param name="~storage_size" value="$(arg storage_size)" />
    <param name="~fragment_duration" value="$(arg fragment_duration)" />
    
    <!-- Output management -->
    <param name="~output_to_screen" value="$(arg output_to_screen)" />
    
    <!-- AWS configuration -->
    <param name="~stream_name" value="$(arg stream_name)" />
    <param name="~aws_region" value="$(arg aws_region)" />
  </node>

  <!-- ========================================== -->
  <!-- PERFORMANCE NOTES -->
  <!-- ========================================== -->
  <!-- 
  RESOURCE IMPACT ON JETSON NANO (4GB RAM):
  
  Configuration         | CPU Usage | RAM Usage | Network
  =====================|===========|===========|==========
  1280x720 @ 30fps     | 40-55%    | 200-300MB | 3 Mbps
  3000 kbps            |           |           |
  
  RECOMMENDATIONS:
  1. Ensure good WiFi signal (5GHz preferred)
  2. Monitor CPU temperature with: watch -n 1 sensors
  3. If CPU > 80Â°C, consider adding heatsink/fan
  4. Reduce resolution if navigation becomes laggy
  
  TROUBLESHOOTING AWS CONSOLE:
  1. Wait 30-60 seconds for first fragments
  2. Use HLS playback instead of MPEG-DASH
  3. Check IAM permissions for KVS
  4. Verify network connectivity to AWS
  -->

  <!-- ========================================== -->
  <!-- HEALTH MONITORING -->
  <!-- ========================================== -->
  <!-- Monitor streaming status -->
  <node pkg="rostopic" type="rostopic" name="stream_monitor" 
       args="echo /kvs/streaming" 
       output="screen" if="$(arg output_to_screen)" />

</launch>