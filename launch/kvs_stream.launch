<!--
     ElderlyBot KVS Stream Launch File - FINAL PRODUCTION SETTINGS
     - 1280x720 @ 15fps, 2000kbps, 8s fragment (no low-res fallback)
     - Hardware encoding (nvh264enc) for Jetson Nano
     - 15fps and 2000kbps for stable streaming on limited CPU/network
     - 8s fragment for high-latency tolerance (Cairo â†’ us-east-1)
     - No low-res fallback: always 720p for cloud/live viewing
     - See kvs_streamer_node.py for pipeline details and rationale
     - If instability occurs, check WiFi signal and AWS region latency
-->

<launch>
  <!-- ========================================== -->
  <!-- ARGUMENTS -->
  <!-- ========================================== -->
  <arg name="device" default="/dev/video0" 
       doc="USB camera device path" />
  
  <!-- HIGH RESOLUTION SETTINGS - 1280x720 @ 30fps -->
  <arg name="width" default="1280" 
       doc="Camera width (1280 for high resolution)" />
  <arg name="height" default="720" 
       doc="Camera height (720 for high resolution)" />
  <arg name="fps" default="30" 
       doc="Frame rate (30fps for smooth video)" />
  
  <!-- KVS Streaming -->
  <arg name="enable_kvs" default="true" 
       doc="Enable AWS KVS streaming" />
  <arg name="bitrate" default="3000" 
       doc="H.264 bitrate in kbps (3000 for 1280x720)" />
  
  <!-- AWS KVS stream configuration -->
  <arg name="stream_name" default="RobotStream" 
       doc="AWS KVS stream name" />
  <arg name="aws_region" default="us-east-1" 
       doc="AWS region" />
  
  <!-- KVS Stability Parameters - Enhanced -->
  <arg name="retry_count" default="5" 
       doc="Number of stream reconnection attempts" />
  <arg name="retry_delay" default="3" 
       doc="Seconds between retries" />
  <arg name="buffer_duration" default="180" 
       doc="Buffer time in seconds for network drops" />
  <arg name="connection_timeout" default="45" 
       doc="Connection timeout in seconds" />
  <arg name="storage_size" default="512" 
       doc="Buffer storage in MB" />
  
  <!-- AWS Console playback optimization -->
  <arg name="fragment_duration" default="5" 
       doc="Fragment duration in seconds (5s for AWS console)" />
  
  <!-- Output Management -->
  <arg name="output_to_screen" default="true" 
       doc="Output KVS logs to screen" />

  <!-- ========================================== -->
  <!-- CAMERA NODE -->
  <!-- ========================================== -->
  <node pkg="elderly_bot" type="camera_node.py" name="camera_publisher" 
        output="screen" respawn="true" respawn_delay="5">
    <param name="device" value="$(arg device)" />
    <param name="width" value="$(arg width)" />
    <param name="height" value="$(arg height)" />
    <param name="fps" value="$(arg fps)" />
    <param name="frame_id" value="camera_link" />
  </node>

  <!-- ========================================== -->
  <!-- AWS KVS STREAMER NODE -->
  <!-- ========================================== -->
  <node pkg="elderly_bot" type="kvs_streamer_node.py" name="kvs_streamer" 
        output="screen" respawn="true" respawn_delay="10" if="$(arg enable_kvs)">
    
    <!-- AWS Environment Variables -->
    <env name="AWS_DEFAULT_REGION" value="$(arg aws_region)" />
    <!-- Suppress GStreamer logs -->
    <env name="GST_DEBUG" value="1" />
    <env name="GST_DEBUG_NO_COLOR" value="1" />
    
    <!-- Video parameters -->
    <param name="width" value="$(arg width)" />
    <param name="height" value="$(arg height)" />
    <param name="fps" value="$(arg fps)" />
    <param name="bitrate" value="$(arg bitrate)" />
    
    <!-- Stability parameters -->
    <param name="~retry_count" value="$(arg retry_count)" />
    <param name="~retry_delay" value="$(arg retry_delay)" />
    <param name="~buffer_duration" value="$(arg buffer_duration)" />
    <param name="~connection_timeout" value="$(arg connection_timeout)" />
    <param name="~storage_size" value="$(arg storage_size)" />
    <param name="~fragment_duration" value="$(arg fragment_duration)" />
    
    <!-- Output management -->
    <param name="~output_to_screen" value="$(arg output_to_screen)" />
    
    <!-- AWS configuration -->
    <param name="~stream_name" value="$(arg stream_name)" />
    <param name="~aws_region" value="$(arg aws_region)" />
  </node>

  <!-- ========================================== -->
  <!-- FINAL PRODUCTION SETTINGS FOR STABILITY (Jetson Nano, AWS KVS):
       - 1280x720 @ 15fps, 2000kbps, 8s fragment
       - Hardware encoding (nvh264enc) ensures low CPU usage
       - 8s fragment improves reliability on high-latency networks
       - No low-res fallback: 720p is always used for cloud and live viewing
       - If instability occurs, check WiFi signal and AWS region latency
  ========================================== -->

  <!-- ========================================== -->
  <!-- HEALTH MONITORING -->
  <!-- ========================================== -->
  <!-- Monitor streaming status -->
  <node pkg="rostopic" type="rostopic" name="stream_monitor" 
       args="echo /kvs/streaming" 
       output="screen" if="$(arg output_to_screen)" />

</launch>