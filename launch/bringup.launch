<?xml version="1.0"?>
<!--
  Elderly Bot Bringup Launch File

  Starts:
  - rosserial WiFi connection to ESP32
  - RPLidar node
  - Static TF transforms

  This launch file brings up the core hardware interfaces.
-->
<launch>
  <!-- ========== PARAMETERS ========== -->

  <!-- ESP32 WiFi connection parameters -->
  <arg name="esp32_ip" default="192.168.1.16" />
  <arg name="esp32_port" default="11411" />

  <!-- Serial port for RPLidar -->
  <arg name="lidar_port" default="/dev/ttyUSB0" />
  <arg name="lidar_baud" default="115200" />
  
  <!-- IMU source: "esp32" or "jetson" -->
  <!-- "esp32": IMU on ESP32 (default, via rosserial) -->
  <!-- "jetson": IMU directly on Jetson I2C (more reliable) -->
  <arg name="imu_source" default="esp32" />
  
  <!-- Camera and KVS streaming -->
  <arg name="enable_camera" default="true" 
       doc="Enable camera and KVS streaming (default: true)" />
  <arg name="kvs_silent" default="true" 
       doc="Suppress KVS debug output (logs to file)" />
  <arg name="camera_device" default="/dev/video0" 
       doc="USB camera device path" />
  <arg name="kvs_test_mode" default="false" 
       doc="Use test resolution (1280x720@30fps) instead of production (640x480@15fps)" />
  
  <!-- Robot geometry parameters -->
  <param name="robot_description" 
         textfile="$(find elderly_bot)/urdf/elderly_bot.urdf" />
  
  <!-- ========== ROBOT STATE PUBLISHER ========== -->
  <!-- Publishes TF transforms from URDF robot_description -->
  <node name="robot_state_publisher" 
        pkg="robot_state_publisher" 
        type="robot_state_publisher"
        output="screen">
    <param name="publish_frequency" value="50.0" />
  </node>
  
  <!-- ========== ROSSERIAL NODE (ESP32 WiFi) ========== -->

  <node name="esp32_serial_node"
        pkg="rosserial_python"
        type="serial_node.py"
        output="screen"
        respawn="true"
        respawn_delay="5"
        args="tcp $(arg esp32_port)">
    <!-- TCP optimization parameters -->
    <param name="tcp_nodelay" value="1" />
    <param name="baud" value="115200" />
  </node>

  <!-- Message info service for rosserial custom messages -->
  <node name="rosserial_message_info"
        pkg="rosserial_python"
        type="message_info_service.py"
        output="screen" />
  
  <!-- ========== RPLIDAR NODE ========== -->
  <!-- Graceful degradation: continues if RPLIDAR not connected -->
  
  <node name="rplidar_node" 
        pkg="rplidar_ros" 
        type="rplidarNode"
        output="screen"
        respawn="false"
        required="false">
    <param name="serial_port" type="string" value="$(arg lidar_port)" />
    <param name="serial_baudrate" type="int" value="$(arg lidar_baud)" />
    <param name="frame_id" value="laser" />
    <param name="inverted" value="false" />
    <param name="angle_compensate" value="true" />
    <param name="scan_mode" value="Standard" />
    
    <!-- LASER MODEL FIX: Filter invalid/noisy points -->
    <!-- Limit max distance to 8m (matches gmapping maxRange) -->
    <!-- RPLidar returns garbage >8m (reflections, max-range artifacts) -->
    <param name="max_distance" value="8.0" />  <!-- Filter points >8m -->
    
    <!-- Angle filtering (optional - uncomment if side reflections are issues) -->
    <!-- <param name="angle_min" value="-3.14159" /> -->  <!-- -180° -->
    <!-- <param name="angle_max" value="3.14159" /> -->   <!-- +180° -->
  </node>
  
  <!-- ========== STATIC TRANSFORMS ========== -->
  <!-- Note: base_footprint, base_link, laser transforms are now published -->
  <!-- by robot_state_publisher from URDF. Only add static transforms here -->
  <!-- that are NOT defined in the URDF. -->
  
  <!-- ========== IMU PIPELINE (Jetson with Sensor Fusion) ========== -->
  <!-- Includes: MPU9250 raw data (gyro+accel) + imu_filter_madgwick + static TF -->
  <!-- Publishes: /imu/data_raw, /imu/data (fused). Magnetometer DISABLED. -->
  
  <include file="$(find elderly_bot)/launch/imu_nav.launch" />
  
  <!-- ========== ROBOT LOCALIZATION EKF ========== -->
  <!-- Fuses /wheel_odom + /imu/data → /odometry/filtered -->
  
  <node pkg="robot_localization" 
        type="ekf_localization_node" 
        name="ekf_localization"
        output="screen"
        clear_params="true">
    <rosparam command="load" file="$(find elderly_bot)/config/ekf.yaml" />
  </node>
  
  <!-- ========== OPTIONAL: SENSORS & ACTUATORS ========== -->
  <!-- Gas sensor (MQ-6), buzzer, Jetson monitoring -->
  <!-- Enabled by default. Disable with: enable_sensors:=false -->
  <!-- Configure in: config/sensors_actuators.yaml -->
  
  <arg name="enable_sensors" default="true" />
  
  <group if="$(arg enable_sensors)">
    <node name="sensors_actuators_node" 
          pkg="elderly_bot" 
          type="sensors_actuators_node.py"
          respawn="true"
          respawn_delay="5">
      <rosparam command="load" file="$(find elderly_bot)/config/sensors_actuators.yaml" />
    </node>
  </group>
  
  <!-- ========== OPTIONAL: CLOUD BRIDGE ========== -->
  <!-- AWS IoT Core MQTT bridge for remote monitoring/control -->
  <!-- Enable with: roslaunch elderly_bot bringup.launch enable_cloud:=true -->
  <!-- Configure in: config/cloud_config.yaml -->
  
  <arg name="enable_cloud" default="false" />
  
  <group if="$(arg enable_cloud)">
    <node name="cloud_bridge_node" 
          pkg="elderly_bot" 
          type="cloud_bridge_node.py"
          output="screen"
          respawn="true"
          respawn_delay="10">
      <rosparam command="load" file="$(find elderly_bot)/config/cloud_config.yaml" />
    </node>
  </group>
  
  <!-- ========== CAMERA & KVS STREAMING ========== -->
  <!-- Camera capture and AWS Kinesis Video Streams -->
  <!-- Enabled by default. Disable with: enable_camera:=false -->
  <!-- Note: camera_link TF is already defined in URDF -->
  <!-- Resolution modes: production (640x480@15fps, default) or test (1280x720@30fps) -->
  
  <group if="$(arg enable_camera)">
    <!-- Production mode: 640x480 @ 15fps, 512kbps (default) -->
    <group unless="$(arg kvs_test_mode)">
      <include file="$(find elderly_bot)/launch/kvs_stream.launch">
        <arg name="device" value="$(arg camera_device)" />
        <arg name="width" value="640" />
        <arg name="height" value="480" />
        <arg name="fps" value="15" />
        <arg name="bitrate" value="512" />
        <arg name="output_to_screen" value="false" if="$(arg kvs_silent)" />
        <arg name="output_to_screen" value="true" unless="$(arg kvs_silent)" />
        <arg name="enable_kvs" value="true" />
      </include>
    </group>
    
    <!-- Test mode: 1280x720 @ 30fps, 2048kbps -->
    <group if="$(arg kvs_test_mode)">
      <include file="$(find elderly_bot)/launch/kvs_stream.launch">
        <arg name="device" value="$(arg camera_device)" />
        <arg name="width" value="1280" />
        <arg name="height" value="720" />
        <arg name="fps" value="30" />
        <arg name="bitrate" value="2048" />
        <arg name="output_to_screen" value="false" if="$(arg kvs_silent)" />
        <arg name="output_to_screen" value="true" unless="$(arg kvs_silent)" />
        <arg name="enable_kvs" value="true" />
      </include>
    </group>
  </group>
  
</launch>


