<?xml version="1.0"?>
<!--
  Elderly Bot Bringup Launch File - CLEANED VERSION
-->
<launch>
  <!-- ========== PARAMETERS ========== -->

  <!-- ESP32 WiFi connection parameters -->
  <arg name="esp32_ip" default="192.168.1.16" />
  <arg name="esp32_port" default="11411" />

  <!-- Serial port for RPLidar -->
  <arg name="lidar_port" default="/dev/ttyUSB0" />
  <arg name="lidar_baud" default="115200" />
  
  <!-- IMU configuration -->
  <arg name="imu_source" default="jetson" />
  <arg name="enable_imu" default="true" />
  <arg name="i2c_bus" default="1" />
  <arg name="i2c_address" default="0x68" />
  
  <!-- Camera and KVS streaming -->
  <arg name="enable_camera" default="true" />
  <arg name="kvs_silent" default="true" />
  <arg name="camera_device" default="/dev/video0" />
  
  <!-- Robot geometry parameters -->
  <param name="robot_description" 
         textfile="$(find elderly_bot)/urdf/elderly_bot.urdf" />
  
  <!-- ========== ROBOT STATE PUBLISHER ========== -->
  <node name="robot_state_publisher" 
        pkg="robot_state_publisher" 
        type="robot_state_publisher"
        output="screen">
    <param name="publish_frequency" value="50.0" />
  </node>
  
  <!-- ========== ROSSERIAL NODE (ESP32 WiFi) ========== -->
  <node name="esp32_serial_node"
        pkg="rosserial_python"
        type="serial_node.py"
        output="screen"
        respawn="true"
        respawn_delay="5"
        args="tcp $(arg esp32_port)">
    <param name="tcp_nodelay" value="1" />
    <param name="baud" value="115200" />
  </node>
  
  <!-- ========== RPLIDAR NODE ========== -->
  <node name="rplidar_node" 
        pkg="rplidar_ros" 
        type="rplidarNode"
        output="screen"
        respawn="true"
        respawn_delay="10"
        required="false">
    <param name="serial_port" type="string" value="$(arg lidar_port)" />
    <param name="serial_baudrate" type="int" value="$(arg lidar_baud)" />
    <param name="frame_id" value="laser" />
    <param name="inverted" value="false" />
    <param name="angle_compensate" value="true" />
    <param name="scan_mode" value="Standard" />
    <param name="max_distance" value="8.0" />
  </node>
  
  <!-- ========== IMU PIPELINE ========== -->
  <group if="$(arg enable_imu)">
    <group if="$(eval imu_source == 'jetson')">
      <node name="mpu9250_node" 
            pkg="elderly_bot" 
            type="mpu9250_node.py"
            output="screen"
            respawn="true"
            respawn_delay="5">
        <param name="frame_id" value="imu_link" />
        <param name="publish_rate" value="100" />
        <param name="i2c_bus" value="$(arg i2c_bus)" />
        <param name="i2c_address" value="$(arg i2c_address)" />
        <param name="retry_count" value="3" />
        <param name="retry_delay" value="2" />
      </node>
      
      <node name="imu_filter" 
            pkg="imu_filter_madgwick" 
            type="imu_filter_node"
            output="screen"
            respawn="true"
            respawn_delay="5">
        <remap from="/imu/data_raw" to="/imu/data_raw" />
        <remap from="/imu/data" to="/imu/data" />
        <param name="use_mag" value="false" />
        <param name="use_magnetic_field_msg" value="false" />
        <param name="publish_tf" value="false" />
        <param name="reverse_tf" value="false" />
        <param name="fixed_frame" value="odom" />
        <param name="world_frame" value="enu" />
        <param name="gain" value="0.9" />
        <param name="zeta" value="0.05" />
        <param name="mag_bias/x" value="-0.00004252" />
        <param name="mag_bias/y" value="0.00004791" />
        <param name="mag_bias/z" value="0.00002824" />
        <param name="stateless" value="false" />
        <param name="remove_gravity_vector" value="true" />
        <param name="publish_debug_topics" value="false" />
      </node>
    </group>
  </group>
  
  <!-- ========== ROBOT LOCALIZATION EKF ========== -->
  <node pkg="robot_localization" 
        type="ekf_localization_node" 
        name="ekf_localization"
        output="screen"
        respawn="true"
        respawn_delay="5"
        clear_params="true">
    <rosparam command="load" file="$(find elderly_bot)/config/ekf.yaml" />
  </node>
  
  <!-- ========== SENSORS & ACTUATORS ========== -->
  <arg name="enable_sensors" default="true" />
  
  <group if="$(arg enable_sensors)">
    <node name="sensors_actuators_node" 
          pkg="elderly_bot" 
          type="sensors_actuators_node.py"
          output="screen"
          respawn="true"
          respawn_delay="5">
      <rosparam command="load" file="$(find elderly_bot)/config/sensors_actuators.yaml" />
    </node>
  </group>
  
  <!-- ========== CLOUD BRIDGE ========== -->
  <arg name="enable_cloud" default="true" />
  
  <group if="$(arg enable_cloud)">
    <node name="cloud_bridge_node" 
          pkg="elderly_bot" 
          type="cloud_bridge_node.py"
          output="screen"
          respawn="true"
          respawn_delay="10">
      <rosparam command="load" file="$(find elderly_bot)/config/cloud_config.yaml" />
    </node>
  </group>
  
  <!-- ========== CAMERA & KVS STREAMING ========== -->
  <group if="$(arg enable_camera)">
    <include file="$(find elderly_bot)/launch/kvs_stream.launch">
      <arg name="device" value="$(arg camera_device)" />
      <arg name="output_to_screen" value="false" if="$(arg kvs_silent)" />
      <arg name="output_to_screen" value="true" unless="$(arg kvs_silent)" />
      <arg name="enable_kvs" value="true" />
      <arg name="width" value="1280" />
      <arg name="height" value="720" />
      <arg name="fps" value="15" />
      <arg name="bitrate" value="2000" />
      <arg name="fragment_duration" value="8" />
      <arg name="storage_size" value="512" />
    </include>
  </group>
  
  <!-- ========== SYSTEM HEALTH MONITOR (FIXED) ========== -->
  <node name="system_health_monitor"
        pkg="elderly_bot"
        type="system_health_monitor.py"
        output="screen"
        respawn="true"
        respawn_delay="10">
    <param name="check_interval" value="5" />
    <param name="critical_nodes" value="rplidar_node,esp32_serial_node" />
    <param name="optional_nodes" value="mpu9250_node,cloud_bridge_node,sensors_actuators_node" />
  </node>
  
</launch>