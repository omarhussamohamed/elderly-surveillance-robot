<?xml version="1.0"?>
<!--
  Elderly Bot Bringup Launch File - UPDATED WITH RESILIENCE
  Starts:
  - rosserial WiFi connection to ESP32
  - RPLidar node
  - Static TF transforms
  - High resolution camera (1280x720 @ 30fps) with KVS streaming
  - IMU with automatic I2C fallback
  - Cloud bridge with retry mechanism

  This launch file brings up the core hardware interfaces with enhanced resilience.
-->
<launch>
  <!-- ========== PARAMETERS ========== -->

  <!-- ESP32 WiFi connection parameters -->
  <arg name="esp32_ip" default="192.168.1.16" />
  <arg name="esp32_port" default="11411" />

  <!-- Serial port for RPLidar -->
  <arg name="lidar_port" default="/dev/ttyUSB0" />
  <arg name="lidar_baud" default="115200" />
  
  <!-- IMU configuration -->
  <arg name="imu_source" default="jetson" doc="IMU source: 'esp32' or 'jetson' (default)" />
  <arg name="enable_imu" default="true" doc="Enable IMU processing (default: true)" />
  <arg name="i2c_bus" default="1" doc="I2C bus number (default: 1)" />
  <arg name="i2c_address" default="0x68" doc="MPU9250 I2C address (0x68 or 0x69)" />
  
  <!-- Camera and KVS streaming -->
  <arg name="enable_camera" default="true" 
       doc="Enable camera and KVS streaming (default: true)" />
  <arg name="kvs_silent" default="true" 
       doc="Suppress KVS debug output (logs to file)" />
  <arg name="camera_device" default="/dev/video0" 
       doc="USB camera device path" />
  
  <!-- Robot geometry parameters -->
  <param name="robot_description" 
         textfile="$(find elderly_bot)/urdf/elderly_bot.urdf" />
  
  <!-- ========== ROBOT STATE PUBLISHER ========== -->
  <!-- Publishes TF transforms from URDF robot_description -->
  <node name="robot_state_publisher" 
        pkg="robot_state_publisher" 
        type="robot_state_publisher"
        output="screen">
    <param name="publish_frequency" value="50.0" />
  </node>
  
  <!-- ========== ROSSERIAL NODE (ESP32 WiFi) ========== -->
  <node name="esp32_serial_node"
        pkg="rosserial_python"
        type="serial_node.py"
        output="screen"
        respawn="true"
        respawn_delay="5"
        args="tcp $(arg esp32_port)">
    <!-- TCP optimization parameters -->
    <param name="tcp_nodelay" value="1" />
    <param name="baud" value="115200" />
  </node>

  <!-- Message info service for rosserial custom messages -->
  <node name="rosserial_message_info"
        pkg="rosserial_python"
        type="message_info_service.py"
        output="screen" />
  
  <!-- ========== RPLIDAR NODE ========== -->
  <!-- Graceful degradation: continues if RPLIDAR not connected -->
  <node name="rplidar_node" 
        pkg="rplidar_ros" 
        type="rplidarNode"
        output="screen"
        respawn="true"
        respawn_delay="10"
        required="false">
    <param name="serial_port" type="string" value="$(arg lidar_port)" />
    <param name="serial_baudrate" type="int" value="$(arg lidar_baud)" />
    <param name="frame_id" value="laser" />
    <param name="inverted" value="false" />
    <param name="angle_compensate" value="true" />
    <param name="scan_mode" value="Standard" />
    
    <!-- LASER MODEL FIX: Filter invalid/noisy points -->
    <param name="max_distance" value="8.0" />  <!-- Filter points >8m -->
  </node>
  
  <!-- ========== I2C DIAGNOSTIC NODE ========== -->
  <!-- Runs a quick I2C diagnostic before starting IMU -->
  <node name="i2c_diagnostic"
        pkg="elderly_bot"
        type="i2c_diagnostic.py"
        output="screen"
        if="$(arg enable_imu)"
        unless="$(eval imu_source == 'esp32')">
    <param name="i2c_bus" value="$(arg i2c_bus)" />
  </node>
  
  <!-- ========== IMU PIPELINE ========== -->
  <!-- Includes: MPU9250 raw data + imu_filter_madgwick -->
  <!-- With enhanced error handling and retry mechanism -->
  
  <group if="$(arg enable_imu)">
    <group if="$(eval imu_source == 'jetson')">
      <!-- Enhanced IMU launch with retry and fallback -->
      <node name="mpu9250_node" 
            pkg="elderly_bot" 
            type="mpu9250_node.py"
            output="screen"
            respawn="true"
            respawn_delay="5">
        <param name="frame_id" value="imu_link" />
        <param name="publish_rate" value="100" />
        <param name="i2c_bus" value="$(arg i2c_bus)" />
        <param name="i2c_address" value="$(arg i2c_address)" />
        <param name="retry_count" value="3" />
        <param name="retry_delay" value="2" />
      </node>
      
      <!-- IMU filter with resilience -->
      <node name="imu_filter" 
            pkg="imu_filter_madgwick" 
            type="imu_filter_node"
            output="screen"
            respawn="true"
            respawn_delay="5">
        <remap from="/imu/data_raw" to="/imu/data_raw" />
        <remap from="/imu/data" to="/imu/data" />
        
        <!-- Sensor Configuration -->
        <param name="use_mag" value="false" />
        <param name="use_magnetic_field_msg" value="false" />
        <param name="publish_tf" value="false" />
        <param name="reverse_tf" value="false" />
        
        <!-- Frame IDs -->
        <param name="fixed_frame" value="odom" />
        <param name="world_frame" value="enu" />
        
        <!-- Filter Parameters -->
        <param name="gain" value="0.9" />
        <param name="zeta" value="0.05" />
        
        <!-- Magnetometer Calibration (not used but kept for compatibility) -->
        <param name="mag_bias/x" value="-0.00004252" />
        <param name="mag_bias/y" value="0.00004791" />
        <param name="mag_bias/z" value="0.00002824" />
        
        <!-- Orientation Initialization -->
        <param name="stateless" value="false" />
        <param name="remove_gravity_vector" value="true" />
        
        <!-- Output Configuration -->
        <param name="publish_debug_topics" value="false" />
      </node>
    </group>
  </group>
  
  <!-- ========== ROBOT LOCALIZATION EKF ========== -->
  <!-- Fuses /wheel_odom + /imu/data â†’ /odometry/filtered -->
  <node pkg="robot_localization" 
        type="ekf_localization_node" 
        name="ekf_localization"
        output="screen"
        respawn="true"
        respawn_delay="5"
        clear_params="true">
    <rosparam command="load" file="$(find elderly_bot)/config/ekf.yaml" />
  </node>
  
  <!-- ========== SENSORS & ACTUATORS ========== -->
  <!-- Gas sensor (MQ-6), buzzer, Jetson monitoring -->
  <arg name="enable_sensors" default="true" />
  
  <group if="$(arg enable_sensors)">
    <node name="sensors_actuators_node" 
          pkg="elderly_bot" 
          type="sensors_actuators_node.py"
          respawn="true"
          respawn_delay="5">
      <rosparam command="load" file="$(find elderly_bot)/config/sensors_actuators.yaml" />
    </node>
  </group>
  
  <!-- ========== CLOUD BRIDGE ========== -->
  <!-- AWS IoT Core MQTT bridge with enhanced error handling -->
  <arg name="enable_cloud" default="false" />
  
  <group if="$(arg enable_cloud)">
    <!-- Certificate validation check -->
    <node name="certificate_check"
          pkg="elderly_bot"
          type="certificate_check.py"
          output="screen"
          respawn="false"
          required="false">
      <param name="cert_dir" value="/home/omar/catkin_ws/src/elderly_bot/aws_certs" />
    </node>
    
    <!-- Cloud bridge node with retry mechanism -->
    <node name="cloud_bridge_node" 
          pkg="elderly_bot" 
          type="cloud_bridge_node.py"
          output="screen"
          respawn="true"
          respawn_delay="10"
          launch-prefix="bash -c 'sleep 5; $0 $@'">
      <rosparam command="load" file="$(find elderly_bot)/config/cloud_config.yaml" />
      <param name="connection_timeout" value="30" />
      <param name="retry_attempts" value="5" />
      <param name="retry_delay" value="5" />
    </node>
    
    <!-- Cloud status monitor -->
    <node name="cloud_status_monitor"
          pkg="elderly_bot"
          type="cloud_status_monitor.py"
          output="screen"
          respawn="true"
          respawn_delay="10">
      <param name="status_topic" value="/cloud/status" />
      <param name="check_interval" value="10" />
    </node>
  </group>
  
  <!-- ========== CAMERA & KVS STREAMING ========== -->
  <!-- Camera capture and AWS Kinesis Video Streams -->
  <group if="$(arg enable_camera)">
    <!-- Always launch kvs_stream.launch with 720p@15fps, 2000kbps, 8s fragment for maximum stability. -->
    <include file="$(find elderly_bot)/launch/kvs_stream.launch">
      <arg name="device" value="$(arg camera_device)" />
      <arg name="output_to_screen" value="false" if="$(arg kvs_silent)" />
      <arg name="output_to_screen" value="true" unless="$(arg kvs_silent)" />
      <arg name="enable_kvs" value="true" />
      <arg name="width" value="1280" />
      <arg name="height" value="720" />
      <arg name="fps" value="15" />
      <arg name="bitrate" value="2000" />
      <arg name="fragment_duration" value="8" />
      <arg name="storage_size" value="512" />
      <arg name="retry_on_failure" value="true" />
      <arg name="max_retries" value="10" />
    </include>
  </group>
  
  <!-- ========== SYSTEM HEALTH MONITOR ========== -->
  <!-- Monitors all nodes and restarts failed ones -->
  <node name="system_health_monitor"
        pkg="elderly_bot"
        type="system_health_monitor.py"
        output="screen"
        respawn="true"
        respawn_delay="10">
    <param name="check_interval" value="5" />
    <param name="critical_nodes" value="rplidar_node,esp32_serial_node" />
    <param name="optional_nodes" value="mpu9250_node,cloud_bridge_node,sensors_actuators_node" />
  </node>
  
  <!-- ========== LOGGING CONFIGURATION ========== -->
  <!-- Enhanced logging with rotation and compression -->
  <param name="/rosout/log_file" value="/home/omar/.ros/log/bringup_rosout.log" />
  <param name="/rosout/max_file_size" value="100MB" />
  <param name="/rosout/num_files" value="10" />
  
</launch>