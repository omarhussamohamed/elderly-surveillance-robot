<?xml version="1.0"?>
<!--
  Elderly Bot Bringup Launch File

  Starts:
  - rosserial WiFi connection to ESP32
  - RPLidar node
  - Static TF transforms

  This launch file brings up the core hardware interfaces.
-->
<launch>
  <!-- ========== PARAMETERS ========== -->

  <!-- ESP32 WiFi connection parameters -->
  <arg name="esp32_ip" default="192.168.1.16" />
  <arg name="esp32_port" default="11411" />

  <!-- Serial port for RPLidar -->
  <arg name="lidar_port" default="/dev/ttyUSB0" />
  <arg name="lidar_baud" default="115200" />
  
  <!-- IMU source: "esp32" or "jetson" -->
  <!-- "esp32": IMU on ESP32 (default, via rosserial) -->
  <!-- "jetson": IMU directly on Jetson I2C (more reliable) -->
  <arg name="imu_source" default="esp32" />
  
  <!-- Robot geometry parameters -->
  <param name="robot_description" 
         command="cat $(find elderly_bot)/urdf/elderly_bot.urdf" />
  
  <!-- ========== ROBOT STATE PUBLISHER ========== -->
  <!-- Publishes TF transforms from URDF robot_description -->
  <node name="robot_state_publisher" 
        pkg="robot_state_publisher" 
        type="robot_state_publisher"
        output="screen">
    <param name="publish_frequency" value="50.0" />
  </node>
  
  <!-- ========== ROSSERIAL NODE (ESP32 WiFi) ========== -->

  <node name="esp32_serial_node"
        pkg="rosserial_python"
        type="serial_node.py"
        output="screen"
        respawn="true"
        respawn_delay="5"
        args="tcp $(arg esp32_port)">
    <!-- TCP optimization parameters -->
    <param name="tcp_nodelay" value="1" />
    <param name="baud" value="115200" />
  </node>

  <!-- Message info service for rosserial custom messages -->
  <node name="rosserial_message_info"
        pkg="rosserial_python"
        type="message_info_service.py"
        output="screen" />
  
  <!-- ========== RPLIDAR NODE ========== -->
  
  <node name="rplidar_node" 
        pkg="rplidar_ros" 
        type="rplidarNode"
        output="screen"
        respawn="false">
    <param name="serial_port" type="string" value="$(arg lidar_port)" />
    <param name="serial_baudrate" type="int" value="$(arg lidar_baud)" />
    <param name="frame_id" value="laser" />
    <param name="inverted" value="false" />
    <param name="angle_compensate" value="true" />
    <param name="scan_mode" value="Standard" />
  </node>
  
  <!-- ========== STATIC TRANSFORMS ========== -->
  <!-- Note: base_footprint, base_link, laser transforms are now published -->
  <!-- by robot_state_publisher from URDF. Only add static transforms here -->
  <!-- that are NOT defined in the URDF. -->
  
  <!-- ========== IMU PIPELINE (Jetson with Sensor Fusion) ========== -->
  <!-- Includes: MPU9250 raw data + imu_filter_madgwick + static TF -->
  <!-- Publishes: /imu/data_raw, /imu/mag, /imu/temperature, /imu/data (fused) -->
  
  <include file="$(find elderly_bot)/launch/imu_nav.launch" />
  
  <!-- ========== ROBOT LOCALIZATION EKF ========== -->
  <!-- Fuses /wheel_odom + /imu/data â†’ /odometry/filtered -->
  
  <node pkg="robot_localization" 
        type="ekf_localization_node" 
        name="ekf_localization"
        output="screen"
        clear_params="true">
    <rosparam command="load" file="$(find elderly_bot)/config/ekf.yaml" />
  </node>
  
</launch>


